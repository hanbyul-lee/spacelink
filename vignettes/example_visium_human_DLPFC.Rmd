---
title: "Example: Visium Human DLPFC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example: Visium Human DLPFC}
  %\VignetteEngine{knitr::rmarkdown}  
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  out.width = "100%"
)
```

# Application of Spacelink to Visium Human DLPFC Dataset

This vignette demonstrates how to perform spatial gene expression analysis using the `spacelink` package with Visium human dorsolateral prefrontal cortex (DLPFC) dataset.
The dataset is available [here](https://research.libd.org/spatialLIBD/), where we used sample 151673. 
Cell-type proportions were estimated using [RCTD](https://github.com/dmcable/spacexr) with the [CosMx Human Frontal Cortex dataset](https://nanostring.com/products/cosmx-spatial-molecular-imager/ffpe-dataset/human-frontal-cortex-ffpe-dataset/) as the reference. 
The processed example data, saved as `Visium_human_DLPFC`, includes gene expression, spot coordinates, and the estimated cell type proportions.

## Load packages

```{r eval=FALSE}
library(spacelink)
library(Seurat)
library(sctransform)
```

## Load example dataset

```{r eval=FALSE}
data(Visium_human_DLPFC)
counts <- Visium_human_DLPFC$counts
spatial_coords <- Visium_human_DLPFC$spatial_coords
dim(counts)
```

```{r eval=FALSE}
## [1] 33538  3639
```

```{r eval=FALSE}
dim(spatial_coords)
```

```{r eval=FALSE}
## [1] 3639  2
```

## Preprocessing

```{r eval=FALSE}
# Filter mitochondrial and low-expressed genes
counts <- counts[!grepl("(^MT-)|(^mt-)", rownames(counts)),]
counts <- counts[rowSums(counts >= 3) >= ncol(counts)*0.005,]
dim(counts)
```

```{r eval=FALSE}
## [1] 3309  3639
```

```{r eval=FALSE}
# Normalize expression counts using sctransform package
seurat_obj <- CreateSeuratObject(counts = counts)
seurat_norm = SCTransform(seurat_obj, vst.flavor = "v2", verbose = FALSE)
counts <- seurat_norm@assays$SCT$data
```

## Run global Spacelink

```{r eval=FALSE}
# In this example, we use only the first five genes.
global_results <- spacelink_global(normalized_counts = counts[1:5,],
                                   spatial_coords = spatial_coords)
```

### Interpret results

The result will be a data frame with p-value, ESV, and other relevant values for each gene.

The most important columns are

- `pval` : The combined p-values for statistical significance of spatial patterns.
- `padj` : Benjamini-Hochberg adjusted p-values.
- `ESV` : Effective Spatial Variability. Spatial pattern is stronger as ESV is closer to 1.
- `tau.sq` : Non-spatial (nugget) variance.
- `sigma.sq1`, `sigma.sq2`, ... : Spatial variance at different length scales.
- `phi1`, `phi2`, ... : Inverse of gene-specific length scales.

## Run cell-type-specific Spacelink

```{r eval=FALSE}
# Load cell type proportions
cell_type_proportions <- Visium_human_DLPFC$cell_type_proportions
dim(cell_type_proportions)
```

```{r eval=FALSE}
## [1] 3639  9
```

```{r eval=FALSE}
colnames(cell_type_proportions)
```

```{r eval=FALSE}
## [1] "endothelial"  "L2_3"  "L4"  "L6"  "oligodendrocyte"  
## [6] "OPC"  "astro"  "Inh"  "microglia"
```

```{r eval=FALSE}
# In this example, we examine the oligodendrocyte-specific spatial variability.
cell_type_spacelink_results <- 
  spacelink_cell_type(normalized_counts = counts[1:5,], 
                      spatial_coords = spatial_coords, 
                      cell_type_proportions = cell_type_proportions, 
                      focal_cell_type = "oligodendrocyte",
                      global_spacelink_results = global_results, 
                      # The above is not required, though providing global results can slightly improve efficiency.
                      calculate_ESV = TRUE)
```

### Interpret results

The result will be a data frame with p-value and ct-ESV for each gene.

- `pval` : The combined p-values for statistical significance of cell-type-specific spatial patterns.
- `ESV` : Cell-type-specific Effective Spatial Variability (ct-ESV).
