---
title: "Example: Visium Human DLPFC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example: Visium Human DLPFC}
  %\VignetteEngine{knitr::rmarkdown}  
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  out.width = "100%"
)
```

# Application of Spacelink to Visium Human DLPFC Dataset

This vignette demonstrates how to perform spatial gene expression analysis using the `spacelink` package with Visium human dorsolateral prefrontal cortex (DLPFC) dataset.

## Load packages

```{r eval=FALSE}
library(spacelink)
library(Seurat)
library(sctransform)
```

## Load example dataset

```{r eval=FALSE}
data(Visium_human_DLPFC)
counts <- Visium_human_DLPFC$counts
spatial_coords <- Visium_human_DLPFC$spatial_coords
dim(counts)
```

```{r eval=FALSE}
## [1] 33538  3639
```

```{r eval=FALSE}
dim(spatial_coords)
```

```{r eval=FALSE}
## [1] 3639  2
```

## Preprocessing

```{r eval=FALSE}
# Filter mitochondrial and low-expressed genes
counts <- counts[!grepl("(^MT-)|(^mt-)", rownames(counts)),]
counts <- counts[rowSums(counts >= 3) >= ncol(counts)*0.005,]
dim(counts)
```

```{r eval=FALSE}
## [1] 3309  3639
```

## Normalization

```{r eval=FALSE}
# Normalize expression counts using sctransform package
seurat_obj <- CreateSeuratObject(counts = counts)
seurat_norm = SCTransform(seurat_obj, vst.flavor = "v2", verbose = FALSE)
counts <- seurat_norm@assays$SCT$data
```

## Run global Spacelink

```{r eval=FALSE}
# In this example, the first five genes are used.
global_results <- spacelink_global(normalized_counts = counts[1:5,], spatial_coords = spatial_coords)
```

## Interpret results

The result will be a data frame with p-value, ESV, and other relevant values for each gene.

The most important columns are

- `pval` : The combined p-values for statistical significance of spatial patterns.
- `padj` : Benjamini-Hochberg adjusted p-values.
- `ESV` : Effective Spatial Variability. Spatial pattern is stronger as ESV is closer to 1.
- `tau.sq` : Non-spatial (nugget) variance.
- `sigma.sq1`, `sigma.sq2`, ... : Spatial variance at different length scales.
- `phi1`, `phi2`, ... : Inverse of gene-specific length scales.
