---
title: "Getting Started with Spacelink"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with spacelink}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  out.width = "100%"
)
```

The `spacelink` package provides statistical methods for detecting and prioritizing spatially variable genes (SVGs) at both global-tissue and cell-type resolution.

## Installation

Install the development version from GitHub:

```{r eval=FALSE}
# install.packages("devtools")
devtools::install_github("xueweic/spacelink")
```

```{r}
library(spacelink)
```

## Basic Workflow

The typical analysis workflow involves two main steps:

### 1. Global Spatial Analysis

Start with global analysis to identify spatially variable genes:

```{r eval=FALSE}
# Run global spatial variability analysis
global_results <- spacelink_global(
  normalized_counts = normalized_expression_matrix,  # Genes × Spots
  spatial_coords = coordinates,  # Spots × 2 (x,y coordinates)
  n_lengthscales = 5  # Number of spatial bandwidths
)

# View results
head(global_results[order(global_results$ESV, decreasing=T), ])
```

The results include:

- `pval` : Combined p-value for spatial significance
- `padj` : Benjamini-Hochberg adjusted p-values
- `ESV` : Effective Spatial Variability score (0-1)
- `tau.sq` : Nugget variance component
- `sigma.sq1`, `sigma.sq2`, ... : Spatial variance components for each kernel
- `phi1`, `phi2`, ... : Inverse of gene-specific length scales

### 2. Cell-Type-Specific Analysis

If you have cell type proportion information, analyze cell-type-specific spatial patterns:

```{r eval=FALSE}
# Cell-type-specific analysis
cell_type_results <- spacelink_cell_type(
  normalized_counts = normalized_expression_matrix,  # Genes × Spots
  spatial_coords = coordinates,  # Spots × 2 (x,y coordinates)
  cell_type_proportions = cell_type_proportions,  # Spots × Cell-types
  focal_cell_type = cell_type_name,  # Cell type name to test
  global_spacelink_results = global_results,  # Not necessary. Providing global results improves efficiency.
  calculate_ESV = TRUE
)
```

The results include:

- `pval` : Combined p-value for spatial significance
- `ESV` : Cell-type-specific Effective Spatial Variability (ct-ESV) score (0-1)

## Example with Simulated Data

Here's an example of global Spacelink analysis using simulated data:

```{r eval=FALSE}
# Set up simulated data
set.seed(123)
n_spots <- 200
n_genes <- 100

# Generate spatial coordinates (2D grid)
coords <- expand.grid(
  x = seq(0, 10, length.out = sqrt(n_spots)),
  y = seq(0, 10, length.out = sqrt(n_spots))
)

# Generate expression data with spatial patterns
expr_data <- matrix(rnorm(n_genes * n_spots), nrow = n_genes)
rownames(expr_data) <- paste0("Gene_", 1:n_genes)

# Add spatial pattern to some genes
for(i in 1:10) {
  # Create distance-based pattern
  center_x <- runif(1, 2, 8)
  center_y <- runif(1, 2, 8)
  distances <- sqrt((coords$x - center_x)^2 + (coords$y - center_y)^2)
  spatial_effect <- exp(-distances/2)
  expr_data[i, ] <- expr_data[i, ] + 2 * spatial_effect
}

# Run analysis
results <- spacelink_global(
  normalized_counts = expr_data,
  spatial_coords = as.matrix(coords),
  n_lengthscales = 5
)

# View top spatially variable genes
top_genes <- head(results[order(results$ESV, decreasing=TRUE), ], 10)
print(top_genes[, c("ESV", "pval", "padj")])
```
