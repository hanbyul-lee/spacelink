---
title: "Getting Started with spacelink"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with spacelink}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  out.width = "100%"
)
```

# Introduction

The `spacelink` package provides statistical methods for analyzing spatial gene expression patterns across multiple scales. It helps identify genes with significant spatial variability and understand how this variability manifests at different length scales.

## Key Concepts

**Spatial Gene Variability (SGV)**: Measures how gene expression varies across spatial locations in tissue samples.

**Multi-scale Analysis**: Examines spatial patterns at different length scales, from local neighborhoods to global tissue-wide patterns.

**Effective Spatial Variability (ESV)**: A summary score between 0 and 1 that quantifies the overall spatial variability of a gene, with higher values indicating stronger spatial patterns.

## Installation

Install the development version from GitHub:

```{r eval=FALSE}
# install.packages("devtools")
devtools::install_github("xueweic/spacelink")
```

```{r}
library(spacelink)
```

## Basic Workflow

The typical analysis workflow involves three main steps:

### 1. Global Spatial Analysis

Start with global analysis to identify spatially variable genes:

```{r eval=FALSE}
# Run global spatial variability analysis
global_results <- spacelink_global(
  Y = expression_matrix,          # Genes × Spots
  spatial_coords = coordinates,   # Spots × 2 (x,y coordinates)
  n_lengthscales = 5             # Number of spatial scales
)

# View results
head(global_results[order(global_results$pval), ])
```

The results include:
- **ESV**: Effective Spatial Variability score (0-1)
- **pval**: Combined p-value for spatial significance
- **padj**: Benjamini-Hochberg adjusted p-values
- **tau.sq, sigma.sq1, ...**: Variance components at different scales

### 2. Cell Type-Specific Analysis (Optional)

If you have cell type data, analyze cell type-specific spatial patterns:

```{r eval=FALSE}
# Cell type-specific analysis
ct_results <- spacelink_cell_type(
  global_test_res = global_results,
  ct_idx = 1,                    # Cell type index to test
  Y = expression_matrix,
  spatial_coords = coordinates,
  cell_type_data = cell_proportions
)
```

### 3. Calculate Cell Type ESV (Optional)

Calculate ESV scores specific to individual cell types:

```{r eval=FALSE}
# Cell type-specific ESV
esv_results <- spacelink_cell_type_ESV(
  global_test_res = global_results,
  ct_idx = 1,
  Y = expression_matrix,
  spatial_coords = coordinates,
  cell_type_data = cell_proportions
)
```

## Example with Simulated Data

Here's a complete example using simulated data:

```{r eval=FALSE}
# Set up simulated data
set.seed(123)
n_spots <- 200
n_genes <- 100

# Generate spatial coordinates (2D grid)
coords <- expand.grid(
  x = seq(0, 10, length.out = sqrt(n_spots)),
  y = seq(0, 10, length.out = sqrt(n_spots))
)

# Generate expression data with spatial patterns
expr_data <- matrix(rnorm(n_genes * n_spots), nrow = n_genes)
rownames(expr_data) <- paste0("Gene_", 1:n_genes)

# Add spatial pattern to some genes
for(i in 1:10) {
  # Create distance-based pattern
  center_x <- runif(1, 2, 8)
  center_y <- runif(1, 2, 8)
  distances <- sqrt((coords$x - center_x)^2 + (coords$y - center_y)^2)
  spatial_effect <- exp(-distances/2)
  expr_data[i, ] <- expr_data[i, ] + 2 * spatial_effect
}

# Run analysis
results <- spacelink_global(
  Y = expr_data,
  spatial_coords = as.matrix(coords),
  n_lengthscales = 5
)

# View top spatially variable genes
top_genes <- head(results[order(results$pval), ], 10)
print(top_genes[, c("ESV", "pval", "padj")])
```

## Interpreting Results

**ESV Scores**:
- ESV > 0.5: Strong spatial patterns
- ESV 0.2-0.5: Moderate spatial patterns  
- ESV < 0.2: Weak spatial patterns

**P-values**: Test for statistical significance of spatial patterns. Use adjusted p-values (padj) for multiple testing correction.

**Variance Components**: 
- `tau.sq`: Non-spatial (nugget) variance
- `sigma.sq1, sigma.sq2, ...`: Spatial variance at different length scales

## Next Steps

- See `vignette("multiscale-analysis")` for advanced multi-scale analysis
- See `vignette("cell-type-analysis")` for cell type-specific workflows
- Check function documentation with `?spacelink_global`
