---
title: "Cell Type-Specific Spatial Analysis"  
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Cell Type-Specific Spatial Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "figures/",
  out.width = "100%"
)
```

# Cell Type-Specific Analysis

This vignette demonstrates how to analyze spatial patterns specific to individual cell types using the spacelink package. Cell type-specific analysis helps identify genes whose spatial patterns are driven by specific cell populations.

## When to Use Cell Type Analysis

Cell type-specific analysis is useful when:
- You have cell type proportion/abundance data (e.g., from deconvolution methods)
- You want to understand which cell types drive spatial gene expression patterns
- You're interested in cell type-specific spatial variability beyond global patterns

## Required Data

For cell type analysis, you need:
1. **Global analysis results** from `spacelink_global()`
2. **Cell type data**: proportions (e.g., RCTD, SPOTlight) or abundance (e.g., Cell2location, stereoscope)

```{r eval=FALSE}
library(spacelink)

# First run global analysis
global_results <- spacelink_global(Y, spatial_coords)

# Cell type data should be spots × cell_types matrix
# Each row sums to 1 (proportions) or represents abundance
dim(cell_type_data)  # n_spots × n_cell_types
```

## Basic Cell Type Analysis

### Testing Single Cell Types

Test for spatial patterns specific to one cell type:

```{r eval=FALSE}
# Test cell type 1
ct1_results <- spacelink_cell_type(
  global_test_res = global_results,
  ct_idx = 1,                    # Cell type index to test
  Y = Y,
  spatial_coords = spatial_coords,
  cell_type_data = cell_type_data
)

# Results contain p-values for cell type-specific spatial patterns
head(ct1_results)
```

### Testing All Cell Types

Loop through all cell types:

```{r eval=FALSE}
n_celltypes <- ncol(cell_type_data)
ct_results_list <- list()

for(ct_idx in 1:n_celltypes) {
  ct_results_list[[ct_idx]] <- spacelink_cell_type(
    global_test_res = global_results,
    ct_idx = ct_idx,
    Y = Y,
    spatial_coords = spatial_coords,
    cell_type_data = cell_type_data
  )
}

names(ct_results_list) <- colnames(cell_type_data)
```

## Cell Type-Specific ESV

Calculate ESV scores specific to each cell type:

```{r eval=FALSE}
# ESV for specific cell type
ct1_esv <- spacelink_cell_type_ESV(
  global_test_res = global_results,
  ct_idx = 1,
  Y = Y,
  spatial_coords = spatial_coords,
  cell_type_data = cell_type_data
)

# Results contain cell type-specific ESV scores
head(ct1_esv)
```

## Advanced Analysis

### Compare Global vs Cell Type-Specific Patterns

```{r eval=FALSE}
# Combine results for comparison
comparison_data <- data.frame(
  gene = rownames(global_results),
  global_ESV = global_results$ESV,
  global_pval = global_results$pval,
  ct1_ESV = ct1_esv$ESV,
  ct1_pval = ct1_results$pval
)

# Genes with cell type-specific patterns
ct_specific <- comparison_data[
  comparison_data$ct1_pval < 0.05 & 
  comparison_data$global_pval > 0.1, 
]

# Genes with global but not cell type-specific patterns  
global_only <- comparison_data[
  comparison_data$global_pval < 0.05 & 
  comparison_data$ct1_pval > 0.1,
]

cat("Cell type-specific genes:", nrow(ct_specific), "\n")
cat("Global-only genes:", nrow(global_only), "\n")
```

### Multi-Cell Type Comparison

Compare ESV across multiple cell types:

```{r eval=FALSE}
# Calculate ESV for all cell types
esv_matrix <- matrix(0, nrow = nrow(Y), ncol = n_celltypes)
colnames(esv_matrix) <- colnames(cell_type_data)
rownames(esv_matrix) <- rownames(Y)

for(ct_idx in 1:n_celltypes) {
  ct_esv <- spacelink_cell_type_ESV(
    global_test_res = global_results,
    ct_idx = ct_idx,
    Y = Y,
    spatial_coords = spatial_coords,
    cell_type_data = cell_type_data
  )
  esv_matrix[, ct_idx] <- ct_esv$ESV
}

# Find genes with cell type-specific high ESV
max_esv_per_gene <- apply(esv_matrix, 1, max)
dominant_celltype <- apply(esv_matrix, 1, which.max)

# Genes with strong cell type specificity
specific_genes <- names(which(max_esv_per_gene > 0.4))
```

## Parameter Tuning

### Gating Parameters

The gating parameters `c1` and `c2` control which other cell types are included in the null model:

```{r eval=FALSE}
# More stringent gating (fewer confounding cell types)
ct_strict <- spacelink_cell_type(
  global_test_res = global_results,
  ct_idx = 1,
  Y = Y,
  spatial_coords = spatial_coords,
  cell_type_data = cell_type_data,
  c1 = 0.5,   # Default: 0.25
  c2 = 0.3    # Default: 0.2
)

# More lenient gating (more confounding cell types)
ct_lenient <- spacelink_cell_type(
  global_test_res = global_results,
  ct_idx = 1,
  Y = Y,
  spatial_coords = spatial_coords,
  cell_type_data = cell_type_data,
  c1 = 0.1,
  c2 = 0.1
)
```

### Bandwidth Reduction

Control whether to restrict kernel bandwidths:

```{r eval=FALSE}
# Standard analysis (default: restrict bandwidths)
ct_standard <- spacelink_cell_type(
  global_test_res = global_results,
  ct_idx = 1,
  Y = Y,
  spatial_coords = spatial_coords,
  cell_type_data = cell_type_data,
  is_phi_reduce = TRUE  # Default
)

# Use full bandwidth range
ct_full_bandwidth <- spacelink_cell_type(
  global_test_res = global_results,
  ct_idx = 1,
  Y = Y,
  spatial_coords = spatial_coords,
  cell_type_data = cell_type_data,
  is_phi_reduce = FALSE
)
```

## Visualization

### Heatmap of Cell Type ESV

```{r eval=FALSE}
library(pheatmap)

# Create heatmap of top genes × cell types
top_genes <- head(order(global_results$pval), 50)
esv_subset <- esv_matrix[top_genes, ]

pheatmap(esv_subset,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         main = "Cell Type-Specific ESV",
         color = colorRampPalette(c("white", "blue", "red"))(100))
```

### Compare ESV Distributions

```{r eval=FALSE}
# Box plot of ESV by cell type
library(reshape2)
library(ggplot2)

esv_long <- melt(esv_matrix[max_esv_per_gene > 0.2, ])
colnames(esv_long) <- c("Gene", "CellType", "ESV")

ggplot(esv_long, aes(x = CellType, y = ESV)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "ESV Distribution by Cell Type",
       x = "Cell Type", y = "ESV Score") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Interpretation Guidelines

### ESV Score Interpretation
- **ESV > 0.5**: Strong cell type-specific spatial patterns
- **ESV 0.2-0.5**: Moderate cell type-specific patterns
- **ESV < 0.2**: Weak or no cell type-specific patterns

### P-value Interpretation
- Significant p-values (< 0.05) indicate spatial patterns specific to the tested cell type
- Compare with global analysis p-values to identify cell type-specific vs global patterns

### Common Patterns
1. **Cell type-specific**: High cell type ESV, low global ESV
2. **Globally spatial**: High global ESV, variable cell type ESV
3. **Mixed patterns**: High ESV in multiple cell types

## Practical Example

```{r eval=FALSE}
# Example workflow with simulated data
set.seed(123)

# Simulate cell type data
n_spots <- 200
n_celltypes <- 4
cell_type_data <- matrix(runif(n_spots * n_celltypes), 
                        nrow = n_spots, ncol = n_celltypes)
cell_type_data <- cell_type_data / rowSums(cell_type_data)  # Normalize to proportions
colnames(cell_type_data) <- paste0("CellType_", 1:n_celltypes)

# Run analysis for first cell type
ct1_results <- spacelink_cell_type(
  global_test_res = global_results,
  ct_idx = 1,
  Y = Y,
  spatial_coords = spatial_coords,  
  cell_type_data = cell_type_data
)

# Identify cell type-specific spatial genes
ct1_specific <- which(ct1_results$pval < 0.05 & global_results$pval > 0.1)
cat("Found", length(ct1_specific), "cell type 1-specific spatial genes\n")
```

## Troubleshooting

### Common Issues

1. **Error: "Use spacelink_global with cell-type indicators"**
   - Your cell_type_data contains binary indicators instead of proportions
   - Use global analysis with binary cell type indicators as covariates instead

2. **Very few significant results**
   - Try adjusting gating parameters (`c1`, `c2`)
   - Check if cell type proportions are too uniform
   - Consider using `is_phi_reduce = FALSE`

3. **Long computation time**
   - Increase `n_workers` for parallelization
   - Reduce number of genes or use subset for testing

## Next Steps

- Explore results with visualization tools
- Validate findings with known biology
- Consider functional enrichment analysis of cell type-specific spatial genes
